services:
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    restart: always
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DATABASE_URL=/data/sim.sqlite
      # If using NPM (Docker host), point to host IP or container name if shared network
      # For now, we assume simple internal comms or public URL overriding this
      - WAHA_BASE_URL=http://waha:3000
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - WAHA_API_KEY=${WAHA_API_KEY}
    volumes:
      - ./data:/data
    depends_on:
      - waha

  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    restart: always
    ports:
      - "3000:3000"
    environment:
      # Browser -> Host -> Nginx -> API
      - NEXT_PUBLIC_API_BASE_URL=https://sim.watrix.online/api
      # SSR -> Internal API
      - API_INTERNAL_BASE_URL=http://api:4000
    depends_on:
      - api

  waha:
    image: devlikeapro/waha-plus
    restart: always
    ports:
      - "3001:3000" # Mapped to 3001 to avoid conflict with Web
    environment:
      - WHATSAPP_DEFAULT_ENGINE=NOWEB
      - WAHA_ZIPPER=ZIPPER
      - WAHA_API_KEY=${WAHA_API_KEY}
    volumes:
      - ./waha_sessions:/app/sessions

# volumes: # No named volumes needed for caddy anymore
